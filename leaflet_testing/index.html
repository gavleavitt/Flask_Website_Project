<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Leaflet Map</title>
	<!-- Leaflet css-->
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"/>
	<!-- Other imports! -->
	<!-- leaflet Javascript-->
	<script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"></script>
	<!--jquery adds "$." functionality-->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<!-- leaflet.wms  found from: https://github.com/heigeo/leaflet.wms -->
	<script src="leaflet/Javascript/leaflet.wms.js"></script>
	<!-- leaflet realtime -->
	<script src="leaflet/Javascript/leaflet-realtime.js"></script>
	<!--Use this instead for leaflet.wms? -->
	<!-- <script src="https://cdn.rawgit.com/heigeo/leaflet.wms/gh-pages/dist/leaflet.wms.js"></script> -->
	<!-- leaflet dialog -->
	<script src="leaflet/Javascript/Leaflet.Dialog.js"></script>
	<!-- leaflet dialog css -->
	<link rel="stylesheet" href="leaflet/CSS/Leaflet.Dialog.css"/>
	<!-- leaflet Mouse Position JS-->
	<script src="leaflet/Javascript/L.Control.MousePosition.js"></script>
	<!-- leaflet Mouse Position css -->
	<link rel="stylesheet" href="L.Control.MousePosition.css"/>
	<!-- Custom local javascript functions -->
	<script src="leaflet/Javascript/customfunctions.js"></script>
	<style>
		/*-- Disable scroll bar so title stays in place! */
		/*html, body{overflow:hidden;}*/

		body {
				 padding: 0;
				 margin: 0;
		 }
		 /*
		 html, body, #map {
				 height: 100%;
				 width: 100%;

		 }
		 */
		 html{
			 height: 100%;
			 width: 100%;
		 }
		 #map{
		     position: absolute;
		     top: 0;
		     left: 0;
		     width: 100%;
		     height: 100%;
		 }

		 /*Title Div, this doesnt seem to do anything? */
		 .title-banner {
			 background-color: red;
			 width: 100%;
			 height: 30px;
		 }

		 .title {
			 margin-left: 0.3em;
			 padding: 0;
			 margin: 0;
			 background-color: #cdd0d4;
		 }
		 .panel-right{
			 float:right;
			 height: 100%;
			 width: 53%;
			 padding: 0;
			 margin: 0;
			 background-color: #cdd0d4;

		 }

		 .panel-right-sub{
			 height: 10%;
			 width: 50%;
			 background-color: #cdd0d4;

		 }
		 .bottom-left-panel{
			 height: 10%;
			 width: 50%;
			 background-color: #cdd0d4;
		 }

	 </style>
</head>
<body>
	<div id="map"></div>
	<div class ="title-banner">
		<h1 class="title">Live GPS Tracking</h1>
	</div>
	<script>
		// intilize map:
		var map = L.map('map').setView([36.61,-121.83],13);
		//Add osm basemap
		L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
	    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(map);
		// Create point feature
		//var datapoint1 = L.marker([36.60472,-121.39409]).addTo(map);
		//datapoint1.bindPopup("This is Fort Ord National Monument.");
		// Create an Empty Popup
		//var latLongPopup = L.popup();
		//Set a null time for first loop
		time = null
		//Test icon
		var testIcon = L.icon({
			iconURL: "leaflet/images/raster_icon_self.png",
			iconSize: [38, 95]
		});
		//Live tracking GPS icon, consider using an arrow with a rotation for bearing
		var livemarkersettings = {
			radius: 8,
			weight: 1,
			fillColor: "#FF0010",
			color: "#00FF00",
			fillOpacity: 0.5
		};
		//leaflet dialog plugin options
		var dialog_options = {
			anchor: [90,5],
			position: 'topleft',
			size: [250,450]
		};
		//leaflet Mouse Position plugin, uses leaflet position placement
		var mousepos = {
			position: "bottomright"
		};
		//Geoserver localhost WFS json link
		var dialog = L.control.dialog(dialog_options)
		/**
		Dialog box, live stats are added to this dialog.
		Need to figure out how to add a DOM id to this.
		Contains temp text as the data is loading.
		*/
			.setContent("<p>Info is loading!</p>")
			.addTo(map);
		L.control.mousePosition(mousepos).addTo(map);
		realtime = L.realtime({
			/**
			Leaflet realtime plugin, polls geoserver WFS json service id field for changes and places a marker at the most recent location.
			*/
				url: geoserver,
		    crossOrigin: false,
		    type: 'json'
		}, {
		    interval: 5 * 1000,
				pointToLayer: function (feature, latlng) {
					return L.circleMarker(latlng,livemarkersettings);
				}
		}).addTo(map);
		realtime.on('update', function(e) {
		    Object.keys(e.update).forEach(function(id) {
				var feature = e.update[id];
				//see https://stackoverflow.com/questions/11038252/how-can-i-calculate-the-difference-between-two-times-that-are-in-24-hour-format
				var loggedtime = format_time(feature.properties.gpstime);
				document.getElementsByClassName("leaflet-control-dialog-contents")[0].innerHTML = "Last logged time: <br><b>" + loggedtime + "</b>";
				document.getElementsByClassName("leaflet-control-dialog-contents")[0].innerHTML += "<br><b>(" + timedif(feature.properties.gpstime) + ")</b>";
				document.getElementsByClassName("leaflet-control-dialog-contents")[0].innerHTML += locationtext(feature.properties.poi,feature.properties.city,
					feature.properties.county,feature.properties.trail,feature.properties.dist_nearesttrail,
					feature.properties.road,feature.properties.dist_nearestroad,feature.properties.poi);
				document.getElementsByClassName("leaflet-control-dialog-contents")[0].innerHTML += "<br>Coordinates:" +
					coors(feature.properties.lat,feature.properties.lon,feature.properties.provider);
				document.getElementsByClassName("leaflet-control-dialog-contents")[0].innerHTML += "<br>Phone battery: <br><b>" + feature.properties.battery + "%</b>";
				if (time !== feature.properties.gpstime){
					/**
					Changes map bounds only if the
					*/
					console.log("changing bounds!")
					time = feature.properties.gpstime
					map.fitBounds(realtime.getBounds(), {maxZoom: 13})
				}
				}.bind(this));
		});

	</script>
</body>

</html>
