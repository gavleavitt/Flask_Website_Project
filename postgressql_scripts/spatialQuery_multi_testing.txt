


SELECT gpsdata.id, "POI".location , "California_Places".name AS placename
	FROM gpsdata, "POI","California_Places"
	WHERE ST_Intersects
		(gpsdata.geom, "POI".geom) AND
	ST_Intersects
		(gpsdata.geom, "California_Places".geom)
	ORDER BY 
		gpsdata.time desc  LIMIT 1;

SELECT gpsdata.id, "POI".location
	FROM 
		gpsdata
	LEFT JOIN "POI" ON ST_Intersects(gpsdata.geom,"POI".geom)
	ORDER BY	
		gpsdata.time desc  LIMIT 1;

##Works!
SELECT 
	gpsdata.id AS gpsid, 
	"POI".location AS poi, 
	"California_Places".name AS places
FROM 
	gpsdata		
LEFT JOIN 
	"POI" ON ST_Intersects(gpsdata.geom,"POI".geom)
LEFT JOIN
	"California_Places" ON ST_Intersects(gpsdata.geom,"California_Places".geom)
ORDER BY	
		gpsdata.time desc  LIMIT 1
		
;
##

#Works!		
SELECT
	 roads.name
FROM
	moco_roads AS roads
ORDER BY
	roads.geom <-> (SELECT geom FROM "POI")
LIMIT 1;
##


#works!
SELECT
	 roads.name road
FROM
	moco_roads AS roads
ORDER BY
	roads.geom <-> (SELECT geom FROM gpsdata ORDER BY gpsdata.time desc LIMIT 1)
LIMIT 1
;

#working on, CTE
WITH intersections AS(
SELECT 
	gpsdata.id AS gpsid, 
	"POI".location AS poi, 
	"California_Places".name AS places
FROM 
	gpsdata		
LEFT JOIN 
	"POI" ON ST_Intersects(gpsdata.geom,"POI".geom)
LEFT JOIN
	"California_Places" ON ST_Intersects(gpsdata.geom,"California_Places".geom)
ORDER BY	
		gpsdata.time desc  LIMIT 1
)

SELECT
	 moco_roads.name
FROM
	moco_roads
ORDER BY
	moco_roads.geom <-> (SELECT geom FROM intersections)
LIMIT 1		
;

###testing - Working	
WITH nearestcanidates AS (
SELECT
	 roads.name road
FROM
	moco_roads AS roads
ORDER BY
	roads.geom <-> (SELECT geom FROM gpsdata ORDER BY gpsdata.time desc LIMIT 1)
LIMIT 20),

joined_dat AS (
SELECT 
	gpsdata.id AS gpsid, 
	"POI".location AS poi, 
	"California_Places".name AS places
FROM 
	gpsdata		
LEFT JOIN 
	"POI" ON ST_Intersects(gpsdata.geom,"POI".geom)
LEFT JOIN
	"California_Places" ON ST_Intersects(gpsdata.geom,"California_Places".geom)
ORDER BY	
		gpsdata.time desc  LIMIT 1)
SELECT 
	joined_dat.*, 
	nearestcanidates.*
FROM
	joined_dat, nearestcanidates
;


##Testing-working-worthless degrees
WITH nearestcanidates AS (
SELECT
	 roads.name road,
	ST_Distance(roads.geom, (SELECT geom FROM gpsdata ORDER BY gpsdata.time desc LIMIT 1)) AS distance
FROM
	moco_roads AS roads
ORDER BY
	roads.geom <-> (SELECT geom FROM gpsdata ORDER BY gpsdata.time desc LIMIT 1)
LIMIT 20),

joined_dat AS (
SELECT 
	gpsdata.id AS gpsid, 
	"POI".location AS poi, 
	"California_Places".name AS places
FROM 
	gpsdata		
LEFT JOIN 
	"POI" ON ST_Intersects(gpsdata.geom,"POI".geom)
LEFT JOIN
	"California_Places" ON ST_Intersects(gpsdata.geom,"California_Places".geom)
ORDER BY	
		gpsdata.time desc  LIMIT 1)
SELECT 
	joined_dat.*, 
	nearestcanidates.*
FROM
	joined_dat, nearestcanidates
ORDER BY
	nearestcanidates.distance
;